define(["underscore","backbonesrc"],function(){var t=this._,e=this.Backbone;if(t&&e&&JSON){e.Safe=function(e,i,n){this._reload=n&&n.reload&&n.reload===!0,this.uid=e,this.context=i,this.isCollection=!i.set&&i.models&&i.add;var s={events:"add reset",emptyValue:"[]",reload:function(){i.add(this.getData())},toJSON:function(t){return t.collection.toJSON()}},r={events:"change",emptyValue:"{}",reload:function(){i.set(this.getData())},toJSON:function(t){return t.toJSON()}};t.extend(this,this.isCollection?s:r),this.ensureUID(),this._reload&&this.reload(),i.on(this.events,this.store,this)},e.Safe.prototype={ensureUID:function(){t.isNull(this.getData())&&this.create()},create:function(){this.storage().setItem(this.uid,this.emptyValue)},store:function(t){this.storage().setItem(this.uid,JSON.stringify(this.toJSON(t)))},storage:function(){return localStorage},getData:function(){return this._current=this.storage().getItem(this.uid),this._current?JSON.parse(this._current):this._current},reset:function(){this.create()},destroy:function(){this.storage().removeItem(this.uniqueID)}};var i=function(t){var i=t.safe.key?t.safe.key:t.safe,n=t.safe.options||{reload:!0};i&&t&&(t.safe=new e.Safe(i,t,n))},n=function(){e.trigger("extend:Model",{key:"safe",extension:i,initialize:function(){this.trigger("after:initialize")}}),e.trigger("extend:Collection",{key:"safe",extension:i,initialize:function(){this.trigger("after:initialize")}})};return{beam:n}}});